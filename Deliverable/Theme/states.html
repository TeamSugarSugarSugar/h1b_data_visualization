<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="Dashboard">
    <meta name="keyword" content="Dashboard, Bootstrap, Admin, Template, Theme, Responsive, Fluid, Retina">

    <title>H1b Data Visulization</title>

    <!-- Bootstrap core CSS -->
    <link href="assets/css/bootstrap.css" rel="stylesheet">
    <!--external css-->
    <link href="assets/font-awesome/css/font-awesome.css" rel="stylesheet" />

    <!-- Custom styles for this template -->
    <link href="assets/css/style.css" rel="stylesheet">
    <link href="assets/css/style-responsive.css" rel="stylesheet">
    <style>
        .heatmap {
            width: 600px;
            height: 400px;
            margin-left: 20px;

        }
        .application {
          width: 300px;
          height: 300px;
          margin-bottom: 50px;
        }
        .certification {
          width: 300px;
          height: 300px;
        }

    </style>

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>

  <body>

  <section id="container" >
      <!-- **********************************************************************************************************************************************************
      TOP BAR CONTENT & NOTIFICATIONS
      *********************************************************************************************************************************************************** -->
      <!--header start-->
      <header class="header black-bg">
              <div class="sidebar-toggle-box">
                  <div class="fa fa-bars tooltips" data-placement="right" data-original-title="Toggle Navigation"></div>
              </div>
            <!--logo start-->
            <a href="index.html" class="logo"><b>H1b Visa Data Visulization</b></a>
            <!--logo end-->

        </header>
      <!--header end-->

      <!-- **********************************************************************************************************************************************************
      MAIN SIDEBAR MENU
      *********************************************************************************************************************************************************** -->
      <!--sidebar start-->
      <aside>
          <div id="sidebar"  class="nav-collapse ">
              <!-- sidebar menu start-->
              <ul class="sidebar-menu" id="nav-accordion">

              	  <p class="centered"><a href="profile.html"><img src="assets/img/logo.png" class="img-circle" width="60"></a></p>
              	  <h5 class="centered">H1B Visa</h5>

                  <li class="mt">
                      <a href="general_info.html">
                          <i class="fa fa-dashboard"></i>
                          <span>General</span>
                      </a>
                  </li>

                  <li class="mt">
                      <a class="active" href="states.html">
                          <i class="fa fa-dashboard"></i>
                          <span>States</span>
                      </a>
                  </li>

                  <li class="mt">
                      <a href="industry.html">
                          <i class="fa fa-dashboard"></i>
                          <span>Industry</span>
                      </a>
                  </li>

                  <li class="mt">
                      <a href="city.html">
                          <i class="fa fa-dashboard"></i>
                          <span>City</span>
                      </a>
                  </li>

                  <!-- <li class="sub-menu">
                      <a href="javascript:;" >
                          <i class="fa fa-desktop"></i>
                          <span>UI Elements</span>
                      </a>
                      <ul class="sub">
                          <li><a  href="general.html">General</a></li>
                          <li><a  href="buttons.html">Buttons</a></li>
                          <li><a  href="panels.html">Panels</a></li>
                      </ul>
                  </li> -->

                  <!-- <li class="sub-menu">
                      <a href="javascript:;" >
                          <i class="fa fa-cogs"></i>
                          <span>Components</span>
                      </a>
                      <ul class="sub">
                          <li><a  href="calendar.html">Calendar</a></li>
                          <li><a  href="gallery.html">Gallery</a></li>
                          <li><a  href="todo_list.html">Todo List</a></li>
                      </ul>
                  </li> -->
                  <!-- <li class="sub-menu">
                      <a class="active" href="javascript:;" >
                          <i class="fa fa-book"></i>
                          <span>Extra Pages</span>
                      </a>
                      <ul class="sub">
                          <li class="active"><a  href="blank.html">Blank Page</a></li>
                          <li><a  href="login.html">Login</a></li>
                          <li><a  href="lock_screen.html">Lock Screen</a></li>
                      </ul>
                  </li> -->
                  <!-- <li class="sub-menu">
                      <a href="javascript:;" >
                          <i class="fa fa-tasks"></i>
                          <span>Forms</span>
                      </a>
                      <ul class="sub">
                          <li><a  href="form_component.html">Form Components</a></li>
                      </ul>
                  </li>
                  <li class="sub-menu">
                      <a href="javascript:;" >
                          <i class="fa fa-th"></i>
                          <span>Data Tables</span>
                      </a>
                      <ul class="sub">
                          <li><a  href="basic_table.html">Basic Table</a></li>
                          <li><a  href="responsive_table.html">Responsive Table</a></li>
                      </ul>
                  </li> -->
                  <!-- <li class="sub-menu">
                      <a href="javascript:;" >
                          <i class=" fa fa-bar-chart-o"></i>
                          <span>Charts</span>
                      </a>
                      <ul class="sub">
                          <li><a  href="morris.html">Morris</a></li>
                          <li><a  href="chartjs.html">Chartjs</a></li>
                      </ul>
                  </li> -->

              </ul>
              <!-- sidebar menu end-->
          </div>
      </aside>
      <!--sidebar end-->

      <!-- **********************************************************************************************************************************************************
      MAIN CONTENT
      *********************************************************************************************************************************************************** -->
      <!--main content start-->
      <section id="main-content">
          <section class="wrapper site-min-height">
          	<h3><i class="fa fa-angle-right"></i> Application Overview</h3>
          	<div class="row mt">
          		<div class="col-lg-12">
                <div>
                  <p>Plese set the year to display
                  <select id = "selectedYear" onchange="renderMap(this.options[this.selectedIndex].value);">
                    <option value="2010" selected="true">2010</option>
                    <option value="2011">2011</option>
                    <option value="2012">2012</option>
                    <option value="2013">2013</option>
                    <option value="2014">2014</option>
                  </select>
                  &nbsp Click on the map to view details.
                </p>
                <p id="applicationdetail" class="details">&nbsp<p>
                </div>
          		</div>
          	</div>
            <div>
              <div id="heatmap">
                  <svg id="appliedpercentage" class="application"></svg>
              </div>
            </div>
            <div>
              <h3><i class="fa fa-angle-right"></i> Certification Rate</h3>
              <h5 id="certificationdetail">&nbsp</h5>
              <div>
                <svg id="certifiedpercentage" class="certification"></svg>
                <svg class="certification">
                  <image x="0" y="0" width="300" height="300"
                  xlink:href="approved.jpg" />
                </svg>

              </div>
            </div>

		        </section><! --/wrapper -->
      </section><!-- /MAIN CONTENT -->

      <!--main content end-->
      <!--footer start-->
      <footer class="site-footer">
          <div class="text-center">
              2015 - INLS690 Project by (Wanchun Zhao, Zhenwei Wang, Wei Hu, Huiying Ma)
              <a href="blank.html#" class="go-top">
                  <i class="fa fa-angle-up"></i>
              </a>
          </div>
      </footer>
      <!--footer end-->
  </section>

    <!-- js placed at the end of the document so the pages load faster -->
    <script src="assets/js/jquery.js"></script>
    <script src="assets/js/bootstrap.min.js"></script>
    <script src="assets/js/jquery-ui-1.9.2.custom.min.js"></script>
    <script src="assets/js/jquery.ui.touch-punch.min.js"></script>
    <script class="include" type="text/javascript" src="assets/js/jquery.dcjqaccordion.2.7.js"></script>
    <script src="assets/js/jquery.scrollTo.min.js"></script>
    <script src="assets/js/jquery.nicescroll.js" type="text/javascript"></script>
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="./assets/data/convertedstates.js"></script>
    <script src="./assets/data/us_states.js"></script>
    <script src="./assets/data/liquidFillGauge.js"></script>

    <!--common script for all pages-->
    <script src="assets/js/common-scripts.js"></script>

    <!--script for this page-->
    <script type='text/javascript'>
    var w = 600;
    var h = 400;

    //setup our display area
    var svg = d3.select('#heatmap')
                .append('svg')
                .attr('w',w+'px')
                .attr('h',h+'px')
                .attr("class", "heatmap");

    //setup a projection
    var projection = d3.geo.albersUsa()
                    .translate([w/2,h/2])
                    .scale(850); //1000 is the default scale

    var path = d3.geo.path().projection(projection);

    var config_applied = liquidFillGaugeDefaultSettings();
    config_applied.circleThickness = 0.1;
    config_applied.waveAnimateTime = 1000;
    var applied_percentage = loadLiquidFillGauge("appliedpercentage", 0, config_applied);

    var config_certified = liquidFillGaugeDefaultSettings();
    config_certified.circleThickness = 0.1;
    config_certified.waveAnimateTime = 1000;
    var certified_percentage = loadLiquidFillGauge("certifiedpercentage", 0, config_certified);

    function renderMap(year){
      // d3.json('http://unc.edu/~captaint/us-states.json', function(json) {
          //when the json file is loaded
          // set up the paths for each state

          //load the data
          // all_states = all_states;
          // d3.csv('http://unc.edu/~captaint/states_data_conv.csv', function(data) {
             applied_percentage.update(0);
             certified_percentage.update(0);
             document.getElementById("applicationdetail").innerHTML = "&nbsp";

            //  year_data = "case"+year;
             sum_case = all_states[0]["sum"+year];

             matchByState(us_states,all_states);

             function matchByState(data1,data2) {
             // smoosh ag productivity data with the geojson data
             for(var i=0; i<data2.length; i++) {
                 var dataState = data2[i].State_name;
                 for(var j=0; j<data1.length; j++) {
                     var jsonState = data1[j].properties.name;
                     if(dataState == jsonState) {
                         data1[i].properties.value = parseFloat(data2[i]["case"+year])
                         data1[i].properties.certified = parseFloat(data2[i]["certified"+year]);
                         break;
                     }
                  }
              }
              }

            var colours = ["#A9E2F3", "#0B2F3A"];
            var mapColor = d3.scale.linear().range(colours);

             //function to get productivity value
             function getValue(d) {
               //console.log(d.Case_Count_2010);
               return d["case"+year];
             }

             //set up the domain / input of our color scale
            mapColor.domain([
                d3.min(all_states, getValue),
                d3.max(all_states, getValue)
              ]);

            // console.log(d3.min(all_states, getValue));


             function calcColor(d) {
               var value = d.properties.value;
               //console.log(value);
               if(value) {
                 //console.log(color(value))
                 return mapColor(value);// get color from the color Scale
               } else {
                 return '#ccc'; //gray if there is no value
               }
             }

            var statesshowing = svg.selectAll('path').data(us_states);

            statesshowing.exit()
                        .transition()
                        .duration(250)
                        .remove();

            statesshowing.enter()
                 .append("path")
                 .transition()
                 .duration(250)
                 .attr('d',path);

            statesshowing.attr('fill', calcColor);

            statesshowing.on("mouseover", showSelection)
                .on('mouseout', function() {
                  d3.select(this)
                       .transition().duration(250)
                       .attr('fill',calcColor);
                  //document.getElementById("detail").innerHTML = "&nbsp";
                })
                .on("click", showPercentage);
          //  });
      // }); #End of d3.json
    }

    showSelection = function(d){
      d3.select(this).transition().duration(250).attr('fill','orange');
    }

    showPercentage = function(d) {
      var e = document.getElementById("selectedYear");
      var year = e.options[e.selectedIndex].value;
      var details = "In "+ d.properties.name+" there are "+d.properties.value
                    +" cases applied, with the total number of "+sum_case+" case ("+parseFloat((d.properties.value/sum_case)*100).toFixed(2)
                    +"%).";
      document.getElementById("applicationdetail").innerHTML = details;
      document.getElementById("certificationdetail").innerHTML = "Within the "+d.properties.value+" applied, there are "
                                                                  +d.properties.certified +" cases certified ("
                                                                  +parseFloat((d.properties.certified/d.properties.value)*100).toFixed(2)
                                                                  +"%).";
      applied_percentage.update((d.properties.value/sum_case)*100)
      certified_percentage.update((d.properties.certified/d.properties.value)*100);
    }

    renderMap("2010");

    </script>

  </body>
</html>
